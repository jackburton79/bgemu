/*
 * EncryptedStream.cpp
 *
 *  Created on: 23/ago/2013
 *      Author: stefano
 */

#include "EncryptedStream.h"

static const uint8 kEncryptionKey[64] = {
	0x88, 0xa8, 0x8f, 0xba, 0x8a, 0xd3, 0xb9, 0xf5,
	0xed, 0xb1, 0xcf, 0xea, 0xaa, 0xe4, 0xb5, 0xfb,
	0xeb, 0x82, 0xf9, 0x90, 0xca, 0xc9, 0xb5, 0xe7,
	0xdc, 0x8e, 0xb7, 0xac, 0xee, 0xf7, 0xe0, 0xca,
	0x8e, 0xea, 0xca, 0x80, 0xce, 0xc5, 0xad, 0xb7,
	0xc4, 0xd0, 0x84, 0x93, 0xd5, 0xf0, 0xeb, 0xc8,
	0xb4, 0x9d, 0xcc, 0xaf, 0xa5, 0x95, 0xba, 0x99,
	0x87, 0xd2, 0x9d, 0xe3, 0x91, 0xba, 0x90, 0xca
};


EncryptedStream::EncryptedStream(Stream *stream)
	:
	MemoryStream(stream->Size() - 2),
	fKeySize(64)
{
	stream->ReadAt(2, Data(), Size());
}


/* virtual */
ssize_t
EncryptedStream::Read(void* dst, int size)
{
	uint8* pointer = static_cast<uint8*>(dst);
	ssize_t totalSizeRead = 0;
	for (int i = 0; i < size; i++) {
		int32 pos = Position();
		uint8 byteRead;
		size_t read = MemoryStream::Read(&byteRead, sizeof(byteRead));
		totalSizeRead += read;
		if (read < sizeof(byteRead))
			break;
		byteRead ^= kEncryptionKey[pos % fKeySize];
		*pointer++ = byteRead;
	}
	return totalSizeRead;
}
